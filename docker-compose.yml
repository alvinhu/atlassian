version: '3.9'

services:
  jira:
    container_name: jira
    restart: always
    image: atlassian/jira-software:latest
    ports:
      - 8080:8080
    environment:
      # 下面四个环境变量用来配置 /opt/atlassian/jira/conf/server.xml，参考自 /opt/atlassian/etc/server.xml.j2
      - ATL_TOMCAT_SECURE=true
      - ATL_TOMCAT_SCHEME=https
      - ATL_PROXY_NAME=jira.atlassian.com
      - ATL_PROXY_PORT=443
      # 注册代理路径
      - JAVA_OPTS=-javaagent:/opt/atlassian/jira/atlassian-agent-1.3.1.jar
      # 中国上海时区
      - TZ=Asia/Shanghai
    volumes:
      - ./jira/data:/var/atlassian/application-data/jira
      - ./atlassian-agent-1.3.1.jar:/opt/atlassian/jira/atlassian-agent-1.3.1.jar
      - ./mysql-connector-java-8.0.29.jar:/opt/atlassian/jira/atlassian-jira/WEB-INF/lib/mysql-connector-java-8.0.29.jar
    networks:
      atlassian:
        ipv4_address: 172.20.0.2
    depends_on:
      - jira-mysql

  confluence:
    container_name: confluence
    restart: always
    image: atlassian/confluence:latest
    ports:
      - 8090:8090
      - 8091:8091
    environment:
      # 下面四个环境变量用来配置 /opt/atlassian/jira/conf/server.xml，参考自 /opt/atlassian/etc/server.xml.j2
      - ATL_TOMCAT_SECURE=true
      - ATL_TOMCAT_SCHEME=https
      - ATL_PROXY_NAME=confluence.atlassian.com
      - ATL_PROXY_PORT=443
      # 注册代理路径
      - JAVA_OPTS=-javaagent:/opt/atlassian/confluence/atlassian-agent-1.3.1.jar
      # 中国上海时区
      - TZ=Asia/Shanghai
    volumes:
      - ./confluence/data:/var/atlassian/application-data/confluence
      - ./atlassian-agent-1.3.1.jar:/opt/atlassian/confluence/atlassian-agent-1.3.1.jar
      - ./mysql-connector-java-8.0.29.jar:/opt/atlassian/confluence/confluence/WEB-INF/lib/mysql-connector-java-8.0.29.jar
    networks:
      atlassian:
        ipv4_address: 172.20.0.3
    depends_on:
      - conf-mysql

  jira-mysql:
    container_name: jira-mysql
    restart: always
    image: mysql:8.0
    command:
      [
        mysqld,
        --character-set-server=utf8mb4,
        --collation-server=utf8mb4_bin,
        --default-storage-engine=INNODB,
        --innodb-default-row-format=DYNAMIC,
        --innodb-log-file-size=2G
      ]
    environment:
      - MYSQL_ROOT_PASSWORD=atlassian
      - MYSQL_DATABASE=jira
      - MYSQL_USER=jira
      - MYSQL_PASSWORD=jira
    volumes:
      - ./jira/mysql:/var/lib/mysql
    networks:
      atlassian:
        ipv4_address: 172.20.0.4

  conf-mysql:
    container_name: conf-mysql
    restart: always
    image: mysql:8.0
    command:
      [
        mysqld,
        --character-set-server=utf8mb4,
        --collation-server=utf8mb4_bin,
        --default-storage-engine=INNODB,
        --max-allowed-packet=256M,
        --innodb-log-file-size=2G,
        --transaction-isolation=READ-COMMITTED,
        --binlog-format=ROW,
        --log-bin-trust-function-creators=1
      ]
    environment:
      - MYSQL_ROOT_PASSWORD=atlassian
      - MYSQL_DATABASE=confluence
      - MYSQL_USER=confluence
      - MYSQL_PASSWORD=confluence
    volumes:
      - ./confluence/mysql:/var/lib/mysql
    networks:
      atlassian:
        ipv4_address: 172.20.0.5

networks:
  atlassian:
    name: atlassian
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  jira:
  confluence:
  jira-mysql:
  conf-mysql:
